# ğŸ¯ Consignes Claude Code : Ajout recherche VLM Ã  l'interface

## ğŸ“‹ Contexte

**Projet :** Visual Shazam - Recherche de pochettes d'albums  
**Ã‰tat actuel :** Interface existante avec recherche CLIP (visuelle)  
**Objectif :** Ajouter un mode de recherche VLM (sÃ©mantique via descriptions textuelles)

**Base de donnÃ©es :**
- 25,790 albums total
- 490 albums avec VLM (descriptions + embeddings 768D)
- Tous les albums ont CLIP (embeddings visuels 512D)

---

## ğŸ¯ FonctionnalitÃ© Ã  implÃ©menter

Ajouter un **systÃ¨me de recherche multi-mode** permettant Ã  l'utilisateur de choisir entre :
1. **CLIP** (recherche visuelle - existant)
2. **VLM** (recherche sÃ©mantique - nouveau)
3. **Hybrid** (combinaison - placeholder pour futur)

---

## ğŸ“ Architecture proposÃ©e

### Frontend (Interface utilisateur)

#### 1. Ajout d'un sÃ©lecteur de mode

**Localisation :** Dans le composant de recherche principal (probablement `SearchInterface.tsx` ou similaire)

**Ã‰lÃ©ment UI :** 
- Radio buttons ou Tabs pour sÃ©lectionner le mode
- Options : `CLIP` | `VLM` | `Hybrid`
- Mode par dÃ©faut : `CLIP` (pour ne pas casser l'existant)

**Exemple de structure :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Search Albums                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [Enter search query...]               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  Search Mode:                               â”‚
â”‚  (â€¢) CLIP     ( ) VLM     ( ) Hybrid       â”‚
â”‚   Visual    Semantic    Combined            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. Logique de recherche

**Comportement selon le mode sÃ©lectionnÃ© :**

- **Mode CLIP** â†’ Appel Ã  l'endpoint existant (probablement `/api/search` ou `/api/search-clip`)
- **Mode VLM** â†’ Appel au nouvel endpoint `/api/search-vlm`
- **Mode Hybrid** â†’ Afficher "Coming soon" pour l'instant (ou appeler `/api/search-hybrid` si implÃ©mentÃ©)

**Note :** Le mode VLM doit vÃ©rifier cÃ´tÃ© backend qu'il y a des albums avec `vlm_processed = TRUE`.

#### 3. Affichage des rÃ©sultats

**Pour CLIP (existant) :**
- Image de la pochette
- Artist - Album Name
- Genre â€¢ Year â€¢ Score
- Similarity score

**Pour VLM (nouveau) :**
- Tout ce qui est en CLIP +
- **Description VLM** affichÃ©e sous l'image
- Badge "VLM" pour diffÃ©rencier

**Exemple de carte de rÃ©sultat VLM :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Image pochette]    ğŸ·ï¸ VLM                  â”‚
â”‚                                             â”‚
â”‚ Artist Name - Album Name                    â”‚
â”‚ Genre â€¢ 2010 â€¢ â­ 8.5                       â”‚
â”‚ Similarity: 0.87                            â”‚
â”‚                                             â”‚
â”‚ ğŸ“ Description:                             â”‚
â”‚ "The album cover features a minimalist     â”‚
â”‚ design with bold yellow typography on a    â”‚
â”‚ white background. A banana illustration    â”‚
â”‚ is prominently displayed..."               â”‚
â”‚ [Show full description]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. Gestion des albums sans VLM

**ProblÃ¨me :** Seulement 490/25,790 albums ont des embeddings VLM pour l'instant.

**Solution :**
- Afficher un indicateur de progression : "VLM available for 490/25,790 albums (2%)"
- Si aucun rÃ©sultat VLM trouvÃ© : "No VLM results. Try CLIP mode or wait for more albums to be processed."
- Optionnellement : fallback automatique vers CLIP si 0 rÃ©sultats VLM

#### 5. UI/UX amÃ©liorations

**Responsive :**
- Sur mobile : tronquer les descriptions Ã  150 chars avec "... Read more"
- Bouton pour expand/collapse la description complÃ¨te

**Loading states :**
- Spinner pendant la recherche
- Message "Generating semantic embedding..." spÃ©cifique au mode VLM

**Empty states :**
- Si 0 rÃ©sultats : suggestions de queries alternatives
- Messages d'erreur clairs si le backend est down

---

### Backend (API)

#### 1. Nouvel endpoint `/api/search-vlm`

**MÃ©thode :** GET ou POST  
**ParamÃ¨tres :**
- `query` (string, required) : Texte de recherche
- `limit` (number, optional, default: 10) : Nombre de rÃ©sultats
- `min_similarity` (number, optional, default: 0.0) : Seuil minimum
- `filter_warnings` (boolean, optional, default: false) : Exclure albums avec warnings

**Workflow :**

1. **Recevoir la query utilisateur**
   ```
   Input: "minimalist album cover with bold typography"
   ```

2. **GÃ©nÃ©rer l'embedding textuel**
   - Utiliser le modÃ¨le `BAAI/bge-base-en-v1.5`
   - Output : vecteur 768D
   ```
   Embedding: [0.234, -0.567, 0.123, ...]
   ```

3. **Query Supabase**
   ```sql
   SELECT 
     id, 
     artist, 
     album_name, 
     genre,
     release_year,
     pitchfork_score,
     cover_url, 
     vlm_description,
     1 - (vlm_embedding <=> $1::vector) as similarity
   FROM album_covers
   WHERE vlm_processed = TRUE
     AND ($2 OR vlm_warning IS NULL)  -- filter_warnings
   ORDER BY vlm_embedding <=> $1::vector
   LIMIT $3;
   ```
   
   ParamÃ¨tres :
   - `$1` : embedding de la query (768D)
   - `$2` : NOT filter_warnings (inverse du paramÃ¨tre)
   - `$3` : limit

4. **Retourner les rÃ©sultats**
   ```json
   {
     "mode": "vlm",
     "query": "minimalist album cover",
     "results": [
       {
         "id": "123",
         "artist": "The Velvet Underground",
         "album_name": "The Velvet Underground & Nico",
         "genre": "Rock",
         "release_year": 1967,
         "pitchfork_score": 10.0,
         "cover_url": "https://...",
         "vlm_description": "The album cover features a minimalist design...",
         "similarity": 0.87
       },
       ...
     ],
     "total_found": 10,
     "processing_time_ms": 234
   }
   ```

#### 2. Charger le modÃ¨le d'embedding

**Important :** Le modÃ¨le `BAAI/bge-base-en-v1.5` doit Ãªtre chargÃ© **une seule fois** au dÃ©marrage du serveur (pas Ã  chaque requÃªte).

**Pseudo-code :**
```
# Au dÃ©marrage du serveur
text_model = load_model("BAAI/bge-base-en-v1.5")

# Ã€ chaque requÃªte /api/search-vlm
def search_vlm(query):
    embedding = text_model.encode(query)  # Rapide (~50ms)
    results = query_supabase(embedding)
    return results
```

**Librairies nÃ©cessaires :**
- Python : `sentence-transformers`
- Node.js : Utiliser un service Python sÃ©parÃ© ou `@xenova/transformers` (moins optimal)

#### 3. Endpoint `/api/search-hybrid` (optionnel, pour futur)

**Workflow :**
1. GÃ©nÃ©rer embedding CLIP (512D) ET embedding VLM (768D)
2. Faire 2 requÃªtes parallÃ¨les Ã  Supabase
3. Fusionner les rÃ©sultats avec pondÃ©ration :
   ```
   final_score = (w_clip Ã— score_clip) + (w_vlm Ã— score_vlm)
   ```
   Exemples de poids :
   - Balanced : 0.5 / 0.5
   - Visual-heavy : 0.7 / 0.3
   - Semantic-heavy : 0.3 / 0.7

4. Trier par `final_score` et retourner top N

**Note :** Pour l'instant, retourner juste `{"status": "coming_soon"}`.

#### 4. Gestion des erreurs

**Erreurs possibles :**
- ModÃ¨le d'embedding pas chargÃ© â†’ 503 Service Unavailable
- Supabase down â†’ 502 Bad Gateway
- Query vide â†’ 400 Bad Request
- Aucun album VLM disponible â†’ 200 OK avec results vides + message explicatif

**Format d'erreur :**
```json
{
  "error": true,
  "message": "No VLM embeddings available yet. Only 490/25790 albums processed.",
  "code": "VLM_NOT_READY",
  "fallback_suggestion": "Try CLIP mode instead"
}
```

---

## ğŸ—‚ï¸ Modifications de fichiers

### Frontend

**Fichiers probables Ã  modifier :**
- `src/components/SearchInterface.tsx` (ou Ã©quivalent)
- `src/components/ResultCard.tsx` (affichage rÃ©sultats)
- `src/types/search.ts` (types TypeScript)
- `src/api/search.ts` (appels API)
- `src/hooks/useSearch.ts` (logique de recherche)

**Nouveaux types TypeScript suggÃ©rÃ©s :**
```typescript
type SearchMode = 'clip' | 'vlm' | 'hybrid';

interface SearchParams {
  query: string;
  mode: SearchMode;
  limit?: number;
  minSimilarity?: number;
  filterWarnings?: boolean;
}

interface VLMResult extends CLIPResult {
  vlm_description: string;
  vlm_warning?: string;
}
```

### Backend

**Fichiers probables Ã  crÃ©er/modifier :**
- `api/search-vlm.ts` (ou `.py` selon stack)
- `services/embeddings.ts` (chargement modÃ¨le)
- `lib/supabase.ts` (queries)
- `types/api.ts` (types partagÃ©s)

**Structure suggÃ©rÃ©e :**
```
backend/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ search-clip.ts      (existant)
â”‚   â”œâ”€â”€ search-vlm.ts       (nouveau)
â”‚   â””â”€â”€ search-hybrid.ts    (futur)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ clip-embeddings.ts  (existant)
â”‚   â”œâ”€â”€ text-embeddings.ts  (nouveau)
â”‚   â””â”€â”€ model-loader.ts     (nouveau)
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ supabase.ts
```

---

## ğŸ§ª Tests suggÃ©rÃ©s

### Queries de test

**Pour VLM (devrait exceller) :**
- "minimalist album cover with bold typography"
- "dark moody melancholic atmosphere"
- "vintage 80s aesthetic with warm colors"
- "surreal dreamlike imagery"
- "black and white photography"

**Pour CLIP (devrait exceller) :**
- "baby swimming underwater" (visuel spÃ©cifique)
- "red and blue color scheme"
- "person wearing sunglasses"
- Upload d'une image similaire

**Pour comparaison :**
- Tester la mÃªme query sur CLIP et VLM
- Comparer les rÃ©sultats
- Noter les diffÃ©rences

### Cas limites

- Query vide
- Query trÃ¨s longue (>500 chars)
- CaractÃ¨res spÃ©ciaux / emojis
- RequÃªtes en franÃ§ais (le modÃ¨le supporte multilingue)
- 0 rÃ©sultats trouvÃ©s

---

## ğŸ“Š Monitoring / Analytics (optionnel)

**MÃ©triques Ã  tracker :**
- Nombre de recherches par mode (CLIP vs VLM)
- Temps de rÃ©ponse moyen par mode
- Taux de "0 rÃ©sultats"
- Queries les plus frÃ©quentes par mode

**OÃ¹ logger :**
- Console backend (pour debug)
- Service d'analytics (Google Analytics, Mixpanel, etc.)
- Base de donnÃ©es (table `search_logs`)

---

## ğŸ¨ Design suggestions

### Badge de mode

Afficher un badge discret sur chaque rÃ©sultat :
- ğŸ” CLIP (bleu)
- ğŸ§  VLM (vert)
- ğŸ”€ HYBRID (violet)

### Indicateur de disponibilitÃ© VLM

Afficher quelque part dans l'interface :
```
ğŸ“Š VLM Coverage: 490/25,790 albums (2%)
â³ More albums being processed...
```

### Toggle animations

- Transition smooth entre les modes
- Loading skeleton pendant la recherche
- Fade-in des rÃ©sultats

---

## ğŸš€ DÃ©ploiement

### Ordre recommandÃ©

1. **Backend first :**
   - ImplÃ©menter `/api/search-vlm`
   - Tester avec Postman/curl
   - Charger le modÃ¨le d'embedding

2. **Frontend ensuite :**
   - Ajouter le sÃ©lecteur de mode
   - Connecter Ã  l'API VLM
   - Affichage des descriptions

3. **Testing :**
   - Tests unitaires backend
   - Tests E2E frontend
   - User testing

4. **DÃ©ploiement progressif :**
   - Feature flag pour activer/dÃ©sactiver VLM
   - Monitoring des erreurs
   - Rollback plan si problÃ¨me

---

## ğŸ”§ Configuration

### Variables d'environnement Ã  ajouter

```env
# Backend
VLM_MODEL_PATH=BAAI/bge-base-en-v1.5
VLM_ENABLED=true
VLM_MIN_SIMILARITY=0.0
VLM_DEFAULT_LIMIT=10

# Frontend
NEXT_PUBLIC_VLM_ENABLED=true
```

### Supabase

Assurer que les colonnes suivantes existent :
- `vlm_description` (TEXT)
- `vlm_embedding` (vector(768))
- `vlm_processed` (BOOLEAN)
- `vlm_warning` (TEXT)

Index nÃ©cessaire :
```sql
CREATE INDEX idx_vlm_embedding
ON album_covers
USING hnsw (vlm_embedding vector_cosine_ops);
```

---

## ğŸ“š Ressources

**ModÃ¨le d'embedding :**
- Hugging Face : https://huggingface.co/BAAI/bge-base-en-v1.5
- Documentation : https://www.sbert.net/

**Librairies :**
- Python : `pip install sentence-transformers`
- Node.js : `npm install @xenova/transformers` (ou service Python sÃ©parÃ©)

**Supabase vector search :**
- Doc : https://supabase.com/docs/guides/ai/vector-search
- Exemples : https://supabase.com/docs/guides/ai/examples

---

## âœ… Checklist implÃ©mentation

### Backend
- [ ] CrÃ©er endpoint `/api/search-vlm`
- [ ] Charger modÃ¨le `BAAI/bge-base-en-v1.5` au startup
- [ ] ImplÃ©menter gÃ©nÃ©ration d'embedding pour query
- [ ] Query Supabase avec vector search
- [ ] Gestion d'erreurs complÃ¨te
- [ ] Tests unitaires
- [ ] Documentation API

### Frontend
- [ ] Ajouter sÃ©lecteur de mode (CLIP/VLM/Hybrid)
- [ ] State management pour mode sÃ©lectionnÃ©
- [ ] Appel Ã  `/api/search-vlm`
- [ ] Affichage descriptions VLM
- [ ] Badge de mode sur rÃ©sultats
- [ ] Indicateur de disponibilitÃ© VLM
- [ ] Gestion des Ã©tats vides/erreurs
- [ ] Responsive design
- [ ] Tests E2E

### Nice-to-have
- [ ] Expand/collapse descriptions
- [ ] Highlight matching keywords dans descriptions
- [ ] Export rÃ©sultats en CSV
- [ ] Partage de recherche (URL avec query)
- [ ] Historique de recherches
- [ ] Suggestions de queries

---

## ğŸ¯ PrioritÃ©s

**Phase 1 (MVP) :**
- Backend : Endpoint VLM basique
- Frontend : SÃ©lecteur de mode + affichage descriptions

**Phase 2 (AmÃ©liorations) :**
- Gestion erreurs complÃ¨te
- UI polish (animations, badges, etc.)
- Tests exhaustifs

**Phase 3 (AvancÃ©) :**
- Mode Hybrid
- Analytics
- Features nice-to-have

---

## ğŸ’¡ Notes importantes

1. **Performance :** Le modÃ¨le d'embedding doit Ãªtre chargÃ© UNE FOIS au startup, pas Ã  chaque requÃªte.

2. **Fallback :** Si VLM Ã©choue, proposer automatiquement CLIP comme alternative.

3. **Cache :** Envisager de cacher les embeddings de queries frÃ©quentes cÃ´tÃ© backend.

4. **Incremental rollout :** Commencer avec VLM en beta/experimental flag avant de le rendre public.

5. **User education :** Ajouter des tooltips expliquant la diffÃ©rence entre CLIP et VLM.

---

**Document crÃ©Ã© le :** 2024-11-17  
**Version :** 1.0  
**Projet :** Visual Shazam - VLM Integration